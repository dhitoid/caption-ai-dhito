<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Caption AI</title>

<meta name="theme-color" content="#38bdf8" />

<style>
:root{
  --bg:#f8fafc;
  --card:#fff;
  --primary:#38bdf8;
  --primary-dark:#0ea5e9;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e5e7eb;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Inter",sans-serif;
  background:linear-gradient(180deg,#f0f9ff,var(--bg));
  color:var(--text);
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 20px;
  background:#ffffffcc;
  backdrop-filter:blur(10px);
  border-bottom:1px solid var(--border);
}
.brand{font-weight:700;color:var(--primary-dark)}
.auth{position:relative}
.login-btn{
  background:var(--primary);
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
}
.avatar{
  width:36px;height:36px;border-radius:50%;
  cursor:pointer;display:none;
}
.dropdown{
  position:absolute;right:0;top:46px;
  background:#fff;border:1px solid var(--border);
  border-radius:10px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
  display:none;
}
.dropdown button{
  background:none;border:none;
  padding:10px 16px;width:100%;
  text-align:left;cursor:pointer;
}
main{max-width:540px;margin:auto;padding:24px 20px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:20px;margin-bottom:20px;
}
label{font-size:13px;color:var(--muted)}
input,select{
  width:100%;padding:12px;margin-bottom:14px;
  border-radius:12px;border:1px solid var(--border);
}
.primary{
  width:100%;
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:#fff;border:none;padding:14px;
  border-radius:14px;font-weight:600;
  cursor:pointer;
}
.result{
  background:#f8fafc;
  border:1px dashed var(--border);
  border-radius:14px;
  padding:16px;min-height:90px;
  white-space:pre-line;
}
.copy{
  margin-top:12px;background:#e0f2fe;
  border:none;padding:10px;width:100%;
  border-radius:10px;font-weight:600;
  cursor:pointer;
}
footer{text-align:center;font-size:12px;color:var(--muted);padding:20px}
</style>
</head>

<body>

<header>
  <div class="brand">Caption AI</div>
  <div class="auth">
    <button id="loginBtn" class="login-btn">Login Google</button>
    <img id="avatar" class="avatar">
    <div id="dropdown" class="dropdown">
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
</header>

<main>
  <p id="limitInfo" style="font-size:13px;color:#0ea5e9;font-weight:600"></p>
  <h1 id="welcome">Buat Caption Otomatis</h1>
  <p style="color:var(--muted)">Caption profesional IG, WA, TikTok</p>

  <div class="card">
    <label>Platform</label>
    <select id="platform">
      <option>Instagram</option>
      <option>WhatsApp</option>
      <option>TikTok</option>
    </select>

    <label>Produk / Jasa</label>
    <input id="product" placeholder="Contoh: Rumah subsidi">

    <label>Gaya Bahasa</label>
    <select id="style">
      <option>Soft selling</option>
      <option>Hard selling</option>
      <option>Santai</option>
      <option>Profesional</option>
    </select>

    <button id="generate" class="primary">ðŸš€ Buat Caption</button>
  </div>

  <div class="card">
    <label>Hasil Caption</label>
    <div id="result" class="result">â€”</div>
    <button id="copy" class="copy">ðŸ“‹ Salin Caption</button>
  </div>
</main>

<footer>Â© 2026 Caption AI Â· By DHITO</footer>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const supabase = createClient(
  'https://lgkbrgwgdgqfhidjivcr.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxna2JyZ3dnZGdxZmhpZGppdmNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4OTIxMzAsImV4cCI6MjA4MzQ2ODEzMH0.ejJGDTlt_rt69Aa_egmLi8X3mqIMUCaYGzCsXxhgOKY',
  {
    auth:{
      flowType:'pkce',
      detectSessionInUrl:true,
      persistSession:true
    }
  }
)

const { data } = await supabase.auth.getSession()

if (!data.session) {
  // Pastikan UI benar-benar logout
  loginBtn.style.display = 'inline-block'
  avatar.style.display = 'none'
  dropdown.style.display = 'none'
}

/* ===== ELEMENT ===== */
const loginBtn = document.getElementById('loginBtn')
const avatar   = document.getElementById('avatar')
const dropdown = document.getElementById('dropdown')
const logoutBtn= document.getElementById('logoutBtn')
const welcome  = document.getElementById('welcome')
const limitInfo= document.getElementById('limitInfo')

let currentUser = null
const DAILY_LIMIT = 5

/* ===== LOGIN ===== */
loginBtn.onclick = async ()=>{
  await supabase.auth.signInWithOAuth({
    provider:'google',
    options:{ redirectTo: location.origin + location.pathname }
  })
}

/* ===== LOGOUT (iOS SAFE) ===== */
logoutBtn.onclick = async () => {
  await supabase.auth.signOut()

  // ðŸ§¹ Bersihkan hash & state OAuth iOS
  history.replaceState({}, '', location.pathname)

  // ðŸ”¥ Hard redirect (tanpa cache)
  window.location.href =
    location.origin + location.pathname + '?logout=' + Date.now()
}

/* ===== AUTH LISTENER ===== */
supabase.auth.onAuthStateChange((event, session)=>{
  if(session?.user){
    currentUser = session.user

    loginBtn.style.display='none'
    avatar.style.display='block'
    avatar.src = currentUser.user_metadata.picture
    welcome.innerText = 'ðŸ‘‹ Halo, ' + currentUser.user_metadata.full_name

    if(location.hash){
      history.replaceState({},'',location.pathname)
    }

    updateLimitUI()
  }
})

await supabase.auth.getSession()

/* ===== LIMIT SYSTEM ===== */
function today(){
  return new Date().toISOString().slice(0,10)
}

function getUsage(){
  if(!currentUser) return 0

  const dateKey  = `caption_date_${currentUser.id}`
  const countKey = `caption_count_${currentUser.id}`

  if(localStorage.getItem(dateKey) !== today()){
    localStorage.setItem(dateKey, today())
    localStorage.setItem(countKey, '0')
  }

  return Number(localStorage.getItem(countKey) || 0)
}

function incrementUsage(){
  const key = `caption_count_${currentUser.id}`
  localStorage.setItem(key, getUsage() + 1)
}

function isPremium(){
  return currentUser?.user_metadata?.is_premium === true
}

function updateLimitUI(){
  if(isPremium()){
    limitInfo.innerText = 'â­ Akun Premium â€” Unlimited Caption'
  }else{
    const used = getUsage()
    limitInfo.innerText =
      `Gratis: ${DAILY_LIMIT - used} dari ${DAILY_LIMIT} caption tersisa hari ini`
  }
}

/* ===== AVATAR DROPDOWN ===== */
avatar.onclick = ()=>{
  dropdown.style.display =
    dropdown.style.display==='block'?'none':'block'
}

/* ===== GENERATE ===== */
generate.onclick = ()=>{
  if(!currentUser) return alert('Silakan login dulu')

  if(!isPremium()){
    if(getUsage() >= DAILY_LIMIT){
      alert('Limit harian habis ðŸ˜¢\nUpgrade ke Premium untuk unlimited')
      return
    }
  }

  if(!product.value) return alert('Produk wajib diisi')

  result.innerText =
`${product.value}

Solusi praktis siap dipakai di ${platform.value}`

  incrementUsage()
  updateLimitUI()
}

/* ===== COPY ===== */
copy.onclick = ()=>{
  navigator.clipboard.writeText(result.innerText)
  alert('Caption disalin')
}
</script>

</body>
</html>