<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin Panel</title>

<style>
*{box-sizing:border-box}
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
  background:#f1f5f9;
  padding:40px;
}

.card{
  background:#fff;
  max-width:520px;
  margin:auto;
  padding:24px;
  border-radius:14px;
  box-shadow:0 10px 30px rgba(0,0,0,.08);
}

h2{margin:0 0 8px}
small{color:#64748b}

.input{
  width:100%;
  padding:12px;
  margin:14px 0;
  border-radius:10px;
  border:1px solid #cbd5e1;
}

.btn{
  padding:10px 14px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}

.btn-primary{background:#2563eb;color:#fff}
.btn-success{background:#16a34a;color:#fff}
.btn-danger{background:#dc2626;color:#fff}
.btn-ghost{background:#e5e7eb}

.row{display:flex;gap:10px;flex-wrap:wrap}
.result{
  margin-top:16px;
  padding:14px;
  border-radius:12px;
  background:#f8fafc;
}
.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
}
.badge-premium{background:#fde68a;color:#92400e}
.badge-free{background:#e5e7eb;color:#374151}
.loading{text-align:center;color:#64748b}
</style>
</head>

<body>

<div class="card">
  <h2>üîê Admin Panel</h2>
  <small>Kelola user & status premium</small>

  <div id="content" class="loading">Memeriksa login‚Ä¶</div>
</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const supabase = createClient(
  'https://lgkbrgwgdgqfhidjivcr.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxna2JyZ3dnZGdxZmhpZGppdmNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4OTIxMzAsImV4cCI6MjA4MzQ2ODEzMH0.ejJGDTlt_rt69Aa_egmLi8X3mqIMUCaYGzCsXxhgOKY'
)

const ADMIN_URL = 'https://dhitoid.github.io/caption-ai-dhito/admin.html'
const USER_URL  = 'https://dhitoid.github.io/caption-ai-dhito/'

const content = document.getElementById('content')
let selectedUser = null

// ================= AUTH CHECK =================
supabase.auth.onAuthStateChange(async (_, session)=>{
  if(!session?.user){
    await supabase.auth.signInWithOAuth({
      provider:'google',
      options:{ redirectTo: ADMIN_URL }
    })
    return
  }

  const { data } = await supabase
    .from('profiles')
    .select('role')
    .eq('id', session.user.id)
    .single()

  if(data?.role !== 'admin'){
    alert('Akun ini bukan admin')
    await supabase.auth.signOut()
    location.href = USER_URL
    return
  }

  renderAdmin()
})

// ================= UI =================
function renderAdmin(){
  content.innerHTML = `
    <input id="email" class="input" placeholder="Email user">
    <button class="btn btn-primary" onclick="search()">Cari User</button>
    <div id="result"></div>
  `
}

window.search = async ()=>{
  const email = document.getElementById('email').value
  const result = document.getElementById('result')
  if(!email) return alert('Isi email')

  result.innerHTML = 'Mencari‚Ä¶'

  const { data } = await supabase
    .from('profiles')
    .select('id,email,is_premium')
    .ilike('email', email)
    .single()

  if(!data){
    result.innerHTML = '‚ùå User tidak ditemukan'
    return
  }

  selectedUser = data

  result.innerHTML = `
    <div class="result">
      <b>${data.email}</b><br>
      Status:
      <span class="badge ${data.is_premium?'badge-premium':'badge-free'}">
        ${data.is_premium?'Premium':'Free'}
      </span>

      <div class="row" style="margin-top:12px">
        <button class="btn btn-success" onclick="setPremium(true)">Set Premium</button>
        <button class="btn btn-danger" onclick="setPremium(false)">Set Free</button>
      </div>
    </div>
  `
}

window.setPremium = async (status)=>{
  if(!selectedUser) return

  await supabase
    .from('profiles')
    .update({ is_premium: status })
    .eq('id', selectedUser.id)

  alert('‚úÖ Status berhasil diubah')
  search()
}
</script>

</body>
</html>
