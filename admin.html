<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Premium</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Inter",sans-serif;
  background:#f8fafc;
  margin:0;
  color:#0f172a;
}
header{
  padding:16px 20px;
  background:#fff;
  border-bottom:1px solid #e5e7eb;
  font-weight:700;
}
main{
  max-width:720px;
  margin:auto;
  padding:20px;
}
.card{
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:16px;
  padding:16px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.badge{
  font-size:12px;
  padding:4px 10px;
  border-radius:999px;
}
.premium{background:#ecfeff;color:#0369a1}
.free{background:#f1f5f9;color:#475569}
button{
  border:none;
  padding:8px 14px;
  border-radius:999px;
  cursor:pointer;
  font-weight:600;
}
.enable{background:#22c55e;color:#fff}
.disable{background:#ef4444;color:#fff}
.center{
  text-align:center;
  padding:60px 20px;
  color:#64748b;
}
.login-btn{
  background:#38bdf8;
  color:#fff;
  padding:10px 16px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-weight:600;
}
</style>
</head>

<body>

<header>üëë Admin Premium Panel</header>
<main id="app"></main>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const supabase = createClient(
  'https://lgkbrgwgdgqfhidjivcr.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxna2JyZ3dnZGdxZmhpZGppdmNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4OTIxMzAsImV4cCI6MjA4MzQ2ODEzMH0.ejJGDTlt_rt69Aa_egmLi8X3mqIMUCaYGzCsXxhgOKY',
  {
    auth:{
      flowType:'pkce',
      detectSessionInUrl:true,
      persistSession:true
    }
  }
)

const ADMIN_EMAIL='nourmaand@gmail.com'
const app=document.getElementById('app')

function renderLogin(){
  app.innerHTML=`<div class="center"><button id="loginBtn" class="login-btn">Login Google</button></div>`
  document.getElementById('loginBtn').onclick=login
}

async function login(){
  await supabase.auth.signInWithOAuth({
    provider:'google',
    options:{ redirectTo: location.origin+location.pathname }
  })
}

async function renderAdmin(user){
  if(user.email!==ADMIN_EMAIL){
    app.innerHTML='<div class="center">üö´ Akun ini bukan admin</div>'
    return
  }

  const { data:users } = await supabase.from('profiles').select('id,is_premium')
  app.innerHTML=''

  users.forEach(u=>{
    const div=document.createElement('div')
    div.className='card'
    div.innerHTML=`
      <div>
        <b>${u.id}</b><br>
        <span class="badge ${u.is_premium?'premium':'free'}">
          ${u.is_premium?'‚≠ê Premium':'Free'}
        </span>
      </div>
      <button class="${u.is_premium?'disable':'enable'}">
        ${u.is_premium?'Disable':'Enable'}
      </button>`
    div.querySelector('button').onclick=async()=>{
      await fetch('https://lgkbrgwgdgqfhidjivcr.supabase.co/functions/v1/set-premium',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ user_id:u.id, premium:!u.is_premium })
      })
      location.reload()
    }
    app.appendChild(div)
  })
}

supabase.auth.onAuthStateChange((_,session)=>{
  if(session?.user) renderAdmin(session.user)
  else renderLogin()
})

const { data:{ session } } = await supabase.auth.getSession()
session?.user ? renderAdmin(session.user) : renderLogin()
</script>

</body>
</html>
