<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Caption AI</title>

<meta name="theme-color" content="#38bdf8" />

<style>
:root{
  --bg:#f8fafc;
  --card:#fff;
  --primary:#38bdf8;
  --primary-dark:#0ea5e9;
  --text:#0f172a;
  --muted:#64748b;
  --border:#e5e7eb;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Inter",sans-serif;
  background:linear-gradient(180deg,#f0f9ff,var(--bg));
  color:var(--text);
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:14px 20px;
  background:#ffffffcc;
  backdrop-filter:blur(10px);
  border-bottom:1px solid var(--border);
}
.brand{font-weight:700;color:var(--primary-dark)}
.auth{position:relative}
.login-btn{
  background:var(--primary);
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
}
.avatar{
  width:36px;height:36px;border-radius:50%;
  cursor:pointer;display:none;
}
.dropdown{
  position:absolute;right:0;top:46px;
  background:#fff;border:1px solid var(--border);
  border-radius:10px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
  display:none;
}
.dropdown button{
  background:none;border:none;
  padding:10px 16px;width:100%;
  text-align:left;cursor:pointer;
}
main{max-width:540px;margin:auto;padding:24px 20px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:20px;margin-bottom:20px;
}
label{font-size:13px;color:var(--muted)}
input,select{
  width:100%;padding:12px;margin-bottom:14px;
  border-radius:12px;border:1px solid var(--border);
}
.primary{
  width:100%;
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:#fff;border:none;padding:14px;
  border-radius:14px;font-weight:600;
  cursor:pointer;
}
.result{
  background:#f8fafc;
  border:1px dashed var(--border);
  border-radius:14px;
  padding:16px;min-height:90px;
  white-space:pre-line;
}
.copy{
  margin-top:12px;background:#e0f2fe;
  border:none;padding:10px;width:100%;
  border-radius:10px;font-weight:600;
  cursor:pointer;
}
footer{text-align:center;font-size:12px;color:var(--muted);padding:20px}
</style>
</head>

<body>

<header>
  <div class="brand">Caption AI</div>
  <div class="auth">
    <button id="loginBtn" class="login-btn">Login Google</button>
    <img id="avatar" class="avatar">
    <div id="dropdown" class="dropdown">
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
</header>

<main>
  <h1 id="welcome">Buat Caption Otomatis</h1>
  <p style="color:var(--muted)">Caption profesional IG, WA, TikTok</p>

  <div class="card">
    <label>Platform</label>
    <select id="platform">
      <option>Instagram</option>
      <option>WhatsApp</option>
      <option>TikTok</option>
    </select>

    <label>Produk / Jasa</label>
    <input id="product" placeholder="Contoh: Rumah subsidi">

    <label>Gaya Bahasa</label>
    <select id="style">
      <option>Soft selling</option>
      <option>Hard selling</option>
      <option>Santai</option>
      <option>Profesional</option>
    </select>

    <button id="generate" class="primary">ðŸš€ Buat Caption</button>
  </div>

  <div class="card">
    <label>Hasil Caption</label>
    <div id="result" class="result">â€”</div>
    <button id="copy" class="copy">ðŸ“‹ Salin Caption</button>
  </div>
</main>

<footer>Â© 2026 Caption AI Â· By DHITO</footer>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

// ================= SUPABASE =================
const supabase = createClient(
  'https://lgkbrgwgdgqfhidjivcr.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxna2JyZ3dnZGdxZmhpZGppdmNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4OTIxMzAsImV4cCI6MjA4MzQ2ODEzMH0.ejJGDTlt_rt69Aa_egmLi8X3mqIMUCaYGzCsXxhgOKY',
  {
    auth:{
      flowType:'pkce',
      detectSessionInUrl:true,
      persistSession:true
    }
  }
)

// ================= STATE =================
let currentUser = null

// ================= ELEMENT =================
const loginBtn  = document.getElementById('loginBtn')
const avatar    = document.getElementById('avatar')
const dropdown  = document.getElementById('dropdown')
const logoutBtn = document.getElementById('logoutBtn')
const welcome   = document.getElementById('welcome')
const generate  = document.getElementById('generate')
const copyBtn   = document.getElementById('copy')
const result    = document.getElementById('result')

// ================= LOGIN =================
loginBtn.onclick = async ()=>{
  await supabase.auth.signInWithOAuth({
    provider:'google',
    options:{ redirectTo: location.origin + location.pathname }
  })
}

// ================= LOGOUT =================
logoutBtn.onclick = async () => {
  await supabase.auth.signOut()

  // ðŸ”¥ PAKSA CLEAR STORAGE (iOS FIX)
  localStorage.clear()
  sessionStorage.clear()

  // ðŸ”¥ RESET UI MANUAL
  loginBtn.style.display = 'inline-block'
  avatar.style.display = 'none'
  dropdown.style.display = 'none'
  welcome.innerText = 'Buat Caption Otomatis'
  currentUser = null

  // ðŸ”¥ HARD REDIRECT (BUKAN RELOAD)
  window.location.href = location.origin + location.pathname
}

// ================= AUTH LISTENER =================
supabase.auth.onAuthStateChange((event, session)=>{
  currentUser = session?.user || null

  if(currentUser){
    const u = currentUser
    loginBtn.style.display='none'
    avatar.style.display='block'
    avatar.src = u.user_metadata.picture
    welcome.innerText = 'ðŸ‘‹ Halo, ' + u.user_metadata.full_name

    if(location.hash){
      history.replaceState({},'',location.pathname)
    }
  }
})

// ðŸ”¥ WAJIB (Safari / iOS)
await supabase.auth.getSession()

// ================= AVATAR =================
avatar.onclick = ()=>{
  dropdown.style.display =
    dropdown.style.display==='block'?'none':'block'
}

// ================= GENERATE (STEP 3) =================
generate.onclick = ()=>{
  if(!currentUser){
    alert('Silakan login dulu untuk menggunakan Caption AI')
    return
  }

  if(!product.value){
    alert('Produk wajib diisi')
    return
  }

  result.innerText =
`${product.value}

Solusi praktis siap dipakai di ${platform.value}`
}

// ================= COPY (STEP 3) =================
copyBtn.onclick = ()=>{
  if(!currentUser){
    alert('Login dulu untuk menyalin caption')
    return
  }

  navigator.clipboard.writeText(result.innerText)
  alert('Caption disalin')
}
</script>

</body>
</html>