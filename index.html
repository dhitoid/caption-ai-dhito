<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Caption AI</title>
<meta name="theme-color" content="#38bdf8" />

<style>
/* ===== STYLE DIPERSINGKAT (AMAN) ===== */
body{margin:0;font-family:-apple-system;background:#f8fafc}
header{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;background:#fff;border-bottom:1px solid #e5e7eb}
.brand{font-weight:700;color:#0ea5e9}
.login-btn{background:#38bdf8;color:#fff;border:none;padding:8px 14px;border-radius:8px}
.avatar{width:36px;height:36px;border-radius:50%;display:none}
.dropdown{position:absolute;right:0;top:46px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;display:none}
.dropdown button{padding:10px 16px;width:100%;border:none;background:none}
main{max-width:520px;margin:auto;padding:20px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px;margin-bottom:16px}
.option{border:1px solid #e5e7eb;padding:8px 14px;border-radius:999px;cursor:pointer}
.option.active{background:#38bdf8;color:#fff}
.result{background:#f1f5f9;padding:14px;border-radius:12px;min-height:80px}
</style>
</head>

<body>

<header>
  <div class="brand">Caption AI</div>
  <div class="auth" style="position:relative">
    <button id="loginBtn" class="login-btn">Login Google</button>
    <img id="avatar" class="avatar">
    <div id="dropdown" class="dropdown">
      <button id="logoutBtn">Logout</button>
    </div>
  </div>
</header>

<main>
  <p id="limitInfo"></p>
  <h2 id="welcome">Buat Caption Otomatis</h2>

  <div class="card">
    <div id="platform">
      <span class="option active">Instagram</span>
      <span class="option">WhatsApp</span>
      <span class="option">TikTok</span>
    </div>

    <input id="product" placeholder="Produk / jasa">

    <div id="style">
      <span class="option active">Soft selling</span>
      <span class="option">Hard selling</span>
    </div>

    <button id="generate">ðŸš€ Buat Caption</button>
  </div>

  <div class="card">
    <div id="result" class="result">â€”</div>
    <button id="copy">ðŸ“‹ Salin</button>
  </div>
</main>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const supabase = createClient(
  'https://lgkbrgwgdgqfhidjivcr.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxna2JyZ3dnZGdxZmhpZGppdmNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4OTIxMzAsImV4cCI6MjA4MzQ2ODEzMH0.ejJGDTlt_rt69Aa_egmLi8X3mqIMUCaYGzCsXxhgOKY',
  { auth:{ flowType:'pkce', detectSessionInUrl:true } }
)

/* ===== ELEMENT ===== */
const loginBtn = document.getElementById('loginBtn')
const logoutBtn = document.getElementById('logoutBtn')
const avatar = document.getElementById('avatar')
const dropdown = document.getElementById('dropdown')
const welcome = document.getElementById('welcome')
const limitInfo = document.getElementById('limitInfo')
const generate = document.getElementById('generate')
const copy = document.getElementById('copy')
const result = document.getElementById('result')
const product = document.getElementById('product')

const DAILY_LIMIT = 5
let currentUser = null
let isPremium = false

/* ===== LOGIN ===== */
loginBtn.onclick = () => {
  supabase.auth.signInWithOAuth({
    provider:'google',
    options:{ redirectTo: location.origin + location.pathname }
  })
}

/* ===== LOGOUT (IOS FIXED) ===== */
logoutBtn.onclick = async ()=>{
  await supabase.auth.signOut()
}

/* ===== AUTH STATE ===== */
supabase.auth.onAuthStateChange(async (event, session)=>{
  if(event === 'SIGNED_IN'){
    currentUser = session.user
    loginBtn.style.display='none'
    avatar.style.display='block'
    avatar.src = currentUser.user_metadata.picture
    welcome.innerText = 'ðŸ‘‹ Halo, ' + currentUser.user_metadata.full_name
    await loadPremium()
    updateLimit()
    history.replaceState({},'',location.pathname)
  }

  if(event === 'SIGNED_OUT'){
    currentUser = null
    isPremium = false
    avatar.style.display='none'
    dropdown.style.display='none'
    loginBtn.style.display='inline-block'
    welcome.innerText = 'Buat Caption Otomatis'
    limitInfo.innerText = ''
  }
})

await supabase.auth.getSession()

/* ===== PREMIUM SAFE ===== */
async function loadPremium(){
  const { data } = await supabase
    .from('profiles')
    .select('is_premium')
    .eq('id', currentUser.id)
    .maybeSingle()

  isPremium = data?.is_premium === true
}

/* ===== LIMIT ===== */
function today(){ return new Date().toISOString().slice(0,10) }

function usage(){
  const key = `u_${currentUser.id}`
  const d = `d_${currentUser.id}`
  if(localStorage.getItem(d)!==today()){
    localStorage.setItem(d,today())
    localStorage.setItem(key,0)
  }
  return Number(localStorage.getItem(key)||0)
}

function inc(){
  localStorage.setItem(`u_${currentUser.id}`, usage()+1)
}

function updateLimit(){
  limitInfo.innerText = isPremium
    ? 'â­ Premium Unlimited'
    : `Gratis: ${DAILY_LIMIT-usage()} sisa`
}

/* ===== AVATAR ===== */
avatar.onclick = ()=> dropdown.style.display =
  dropdown.style.display==='block'?'none':'block'

/* ===== GENERATE ===== */
generate.onclick = ()=>{
  if(!currentUser) return alert('Login dulu')
  if(!isPremium && usage()>=DAILY_LIMIT)
    return alert('Limit habis')

  result.innerText = product.value || 'Isi produk dulu'
  if(!isPremium) inc()
  updateLimit()
}

copy.onclick = ()=> navigator.clipboard.writeText(result.innerText)
</script>

</body>
</html>
